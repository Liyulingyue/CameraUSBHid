<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂßøÂäøÂΩïÂà∂‰∏éÈÖçÁΩÆ - ÂßøÊÄÅÊ£ÄÊµãÁ≥ªÁªü</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 10px 20px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
        }

        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .recording-section, .frames-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-placeholder {
            text-align: center;
            color: #666;
        }

        .preview-icon {
            font-size: 4em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .preview-placeholder p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .preview-placeholder small {
            opacity: 0.7;
        }

        #recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #f44336;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .frames-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .frame-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .frame-item.selected {
            border-color: #4CAF50;
        }

        .frame-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .frame-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            font-size: 0.8em;
            text-align: center;
        }

        .config-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }

        .form-label {
            color: white;
            font-weight: 500;
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .form-select option {
            background: rgba(0, 0, 0, 0.8);
            color: white;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4CAF50;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .keypoints-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        .status-processing {
            background: #ff9800;
            animation: pulse 1s infinite;
        }

        .status-ready {
            background: #4CAF50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pose-result-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .pose-canvas {
            max-width: 100%;
            border-radius: 4px;
        }

        .keypoints-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .keypoint-item {
            font-size: 0.8em;
        }

        /* ÂÖ≥ÈîÆÁÇπË°®Ê†ºÊ†∑Âºè */
        #keypoints-selector table {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 195, 74, 0.1));
            border-radius: 8px;
            overflow: hidden;
        }

        #keypoints-selector thead {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
        }

        #keypoints-selector tbody tr:nth-child(even) {
            background: rgba(76, 175, 80, 0.05);
        }

        #keypoints-selector tbody tr:nth-child(odd) {
            background: rgba(139, 195, 74, 0.05);
        }

        #keypoints-selector tbody tr:hover {
            background: rgba(76, 175, 80, 0.15);
            transition: background 0.3s ease;
        }

        .pose-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .pose-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .pose-item:hover, .pose-item.selected {
            background: rgba(255, 255, 255, 0.1);
        }

        .pose-item .pose-name {
            font-weight: bold;
        }

        .pose-item .pose-index {
            font-size: 0.8em;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .nav-links a {
                display: block;
                margin: 5px 0;
            }

            .frames-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• ÂßøÂäøÂΩïÂà∂‰∏éÈÖçÁΩÆ</h1>
            <p>ÂΩïÂà∂ËßÜÈ¢ë„ÄÅÊèêÂèñÂ∏ß„ÄÅÊ£ÄÊµãÂÖ≥ÈîÆÁÇπ„ÄÅÈÖçÁΩÆÂßøÂäøÊ®°Êùø</p>
        </div>

        <div class="nav-links">
            <a href="/">‰∏ªÈ°µ</a>
            <a href="/realtime">ÂÆûÊó∂Ê£ÄÊµã</a>
            <a href="/mouse_control">Èº†Ê†áÊéßÂà∂</a>
            <a href="/pose_recorder" class="active">ÂßøÂäøÂΩïÂà∂</a>
        </div>

        <div class="main-content">
        <div class="recording-section">
            <h3>üìπ ËßÜÈ¢ëÂΩïÂà∂</h3>
            <div class="video-container">
                <video id="video-preview" autoplay muted style="display: none; max-width: 100%; max-height: 100%;"></video>
                <video id="recorded-video" controls style="display: none; max-width: 100%; max-height: 100%;"></video>
                <div id="no-camera" style="display: none; text-align: center; padding: 20px;">
                    <p>Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥</p>
                    <p style="font-size: 0.9em; opacity: 0.7;">ËØ∑Á°Æ‰øùÂ∑≤Êéà‰∫àÊëÑÂÉèÂ§¥ÊùÉÈôê</p>
                </div>
                <div id="recording-indicator" style="display: none;">
                    <div class="recording-dot"></div>
                    <span>Ê≠£Âú®ÂΩïÂà∂...</span>
                </div>
            </div>

            <div class="controls">
                <button id="start-record" class="btn btn-primary">ÂºÄÂßãÂΩïÂà∂</button>
                <button id="stop-record" class="btn btn-danger" disabled>ÂÅúÊ≠¢ÂΩïÂà∂</button>
                <button id="process-video" class="btn btn-success" disabled>Â§ÑÁêÜÂ∏ß</button>
                <div class="form-check form-switch ms-3" style="display:inline-block;">
                    <input class="form-check-input" type="checkbox" id="mirror-toggle">
                    <label class="form-check-label" for="mirror-toggle">ÈïúÂÉèÊòæÁ§∫</label>
                </div>
            </div>

            <div class="recording-status">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text">ÂáÜÂ§áÂ∞±Áª™</span>
            </div>
        </div>            <div class="frames-section">
                <h3>üñºÔ∏è Â∏ßÈ¢ÑËßà</h3>
                <div id="frames-container">
                    <p style="text-align: center; opacity: 0.7;">ÂΩïÂà∂Âπ∂Â§ÑÁêÜËßÜÈ¢ëÂêéÔºåÂ∏ßÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</p>
                </div>

                <div class="mt-3">
                    <span class="ms-3">Â∑≤ÈÄâÊã©Â∏ß: <span id="selection-count">Êó†</span></span>
                </div>
            </div>
        </div>

        <div class="config-panel">
            <h3>‚öôÔ∏è ÂßøÂäøÈÖçÁΩÆ</h3>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="existing-poses" class="form-label">ÈÄâÊã©Áé∞ÊúâÂßøÂäø (ÂèØÈÄâ)</label>
                        <select class="form-select" id="existing-poses">
                            <option value="">Êñ∞Âª∫ÂßøÂäø</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="pose-name" class="form-label">ÂßøÂäøÂêçÁß∞</label>
                        <input type="text" class="form-control" id="pose-name" placeholder="‰æãÂ¶Ç: MyPose">
                    </div>
                    <div class="mb-3">
                        <label for="pose-index" class="form-label">ÂßøÂäøÁ¥¢Âºï</label>
                        <input type="number" class="form-control" id="pose-index" placeholder="‰æãÂ¶Ç: 15">
                    </div>
                    <div class="mb-3">
                        <label for="similarity-threshold" class="form-label">Áõ∏‰ººÂ∫¶ÈòàÂÄº</label>
                        <input type="number" class="form-control" id="similarity-threshold" step="0.01" min="0" max="1" value="0.95">
                    </div>
                    <div class="mb-3">
                        <label for="pose-img" class="form-label">ÂßøÂäøÂõæÁâá (ÂèØÈÄâ)</label>
                        <input type="text" class="form-control" id="pose-img" placeholder="‰æãÂ¶Ç: MyPose.jpg">
                        <div class="form-text">ÂÖ≥ËÅîÂà∞ Source/Images ÁõÆÂΩï‰∏ãÁöÑÂõæÁâáÊñá‰ª∂</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="base-keypoint" class="form-label">Âü∫ÂáÜÂÖ≥ÈîÆÁÇπ</label>
                        <select class="form-select" id="base-keypoint">
                            <option value="nose">nose</option>
                            <option value="left_eye">left_eye</option>
                            <option value="right_eye">right_eye</option>
                            <option value="left_ear">left_ear</option>
                            <option value="right_ear">right_ear</option>
                            <option value="left_shoulder">left_shoulder</option>
                            <option value="right_shoulder">right_shoulder</option>
                            <option value="left_elbow">left_elbow</option>
                            <option value="right_elbow">right_elbow</option>
                            <option value="left_wrist">left_wrist</option>
                            <option value="right_wrist">right_wrist</option>
                            <option value="left_hip">left_hip</option>
                            <option value="right_hip">right_hip</option>
                            <option value="left_knee">left_knee</option>
                            <option value="right_knee">right_knee</option>
                            <option value="left_ankle">left_ankle</option>
                            <option value="right_ankle">right_ankle</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="keys-input" class="form-label">Êò†Â∞ÑÊåâÈîÆ (Áî®ÈÄóÂè∑ÂàÜÈöî)</label>
                        <input type="text" class="form-control" id="keys-input" placeholder="‰æãÂ¶Ç: w,a,s,d Êàñ space">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="inner-flag">
                            <label class="form-check-label" for="inner-flag">
                                ÂÜÖÈÉ®ÂßøÂäø (‰∏çÂèÇ‰∏éÂ∏∏ËßÑÊ£ÄÊµã)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Ê†∏ÂøÉÂÖ≥ÈîÆÁÇπÈÄâÊã©</label>
                <div id="keypoints-selector"><!-- Áî±JSÂä®ÊÄÅÁîüÊàêË°®Ê†º --></div>
            </div>

            <div class="mb-3">
                <label class="form-label">ÂßøÂäøÊ£ÄÊµãÁªìÊûú</label>
                <div id="pose-results">
                    Ê£ÄÊµãÂßøÂäøÂêéÂ∞ÜÊòæÁ§∫ÁªìÊûú
                </div>
            </div>

            <div class="controls">
                <button id="save-pose" class="btn btn-success">‰øùÂ≠òÂßøÂäø</button>
                <button id="delete-pose" class="btn btn-danger" disabled>Âà†Èô§ÂßøÂäø</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let mediaRecorder = null;
        let recordedChunks = [];
        let frames = [];
        let selectedFrames = new Set();
        let currentPoseData = null;
        let keypointsData = {};

        // ÂÖ≥ÈîÆÁÇπÂêçÁß∞Êò†Â∞Ñ
        const keypointNames = [
            'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
            'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
            'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
            'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
        ];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeCamera();
            setupEventListeners();
            loadExistingPoses();
            initializeKeypointsSelector();
        });

        // ÂàùÂßãÂåñÊëÑÂÉèÂ§¥
        async function initializeCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: false
                });
                document.getElementById('video-preview').srcObject = stream;
                document.getElementById('video-preview').style.display = 'block';
                updateStatus('ÂáÜÂ§áÂ∞±Áª™', 'ready');
            } catch (error) {
                console.error('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥:', error);
                document.getElementById('no-camera').style.display = 'block';
                updateStatus('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥', 'error');
            }
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            document.getElementById('start-record').addEventListener('click', startRecording);
            document.getElementById('stop-record').addEventListener('click', stopRecording);
            document.getElementById('process-video').addEventListener('click', processVideo);
            document.getElementById('save-pose').addEventListener('click', savePose);
            document.getElementById('delete-pose').addEventListener('click', deletePose);
            document.getElementById('existing-poses').addEventListener('change', loadSelectedPose);
        }

        // ÂºÄÂßãÂΩïÂà∂
        function startRecording() {
            recordedChunks = [];
            const stream = document.getElementById('video-preview').srcObject;

            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                document.getElementById('recorded-video').src = url;
                document.getElementById('recorded-video').style.display = 'block';
                document.getElementById('video-preview').style.display = 'none';
                updateStatus('ÂΩïÂà∂ÂÆåÊàê', 'ready');
                document.getElementById('process-video').disabled = false;
            };

            mediaRecorder.start();
            updateStatus('Ê≠£Âú®ÂΩïÂà∂...', 'recording');
            document.getElementById('start-record').disabled = true;
            document.getElementById('stop-record').disabled = false;
        }

        // ÂÅúÊ≠¢ÂΩïÂà∂
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('start-record').disabled = false;
                document.getElementById('stop-record').disabled = true;
            }
        }

        // Â§ÑÁêÜËßÜÈ¢ë
        async function processVideo() {
            updateStatus('Ê≠£Âú®Â§ÑÁêÜËßÜÈ¢ë...', 'processing');
            document.getElementById('process-video').disabled = true;

            try {
                const video = document.getElementById('recorded-video');
                const duration = video.duration;
                const frameCount = Math.min(20, Math.floor(duration * 2)); // ÊúÄÂ§ö20Â∏ß

                frames = [];
                const framesContainer = document.getElementById('frames-container');
                framesContainer.innerHTML = '<div class="frames-grid" id="frames-grid"></div>';

                const framesGrid = document.getElementById('frames-grid');

                for (let i = 0; i < frameCount; i++) {
                    const time = (i / (frameCount - 1)) * duration;
                    video.currentTime = time;

                    await new Promise(resolve => {
                        video.onseeked = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            // Ê†πÊçÆÈïúÂÉèÂÅèÂ•ΩÂÜ≥ÂÆöÊòØÂê¶ÈïúÂÉèÁªòÂà∂Â∏ßÂà∞canvasÔºàÂΩ±ÂìçÈÄÅÂæÄÂêéÁ´ØÁöÑÂõæÂÉèÂÜÖÂÆπÔºâ
                            const mirror = typeof getMirrorPreference === 'function' ? getMirrorPreference() : true;
                            if (mirror) {
                                ctx.save();
                                // Â∞ÜÂéüÁÇπÁßªÂä®Âà∞Âè≥ËæπÂÜçÊ∞¥Âπ≥ÁøªËΩ¨ÔºåÂÆûÁé∞Á≠âÊïàÁöÑscaleX(-1)
                                ctx.translate(canvas.width, 0);
                                ctx.scale(-1, 1);
                                ctx.drawImage(video, 0, 0);
                                ctx.restore();
                            } else {
                                ctx.drawImage(video, 0, 0);
                            }

                            const frameData = {
                                index: i,
                                time: time,
                                imageData: canvas.toDataURL('image/jpeg', 0.8),
                                mirrored: (typeof getMirrorPreference === 'function') ? getMirrorPreference() : false
                            };
                            frames.push(frameData);

                            // ÂàõÂª∫Â∏ßÈ¢ÑËßà
                            const frameItem = document.createElement('div');
                            frameItem.className = 'frame-item';
                            frameItem.dataset.frameIndex = i;
                            frameItem.onclick = () => selectFrame(i);

                            const img = document.createElement('img');
                            img.src = frameData.imageData;
                            frameItem.appendChild(img);

                            const info = document.createElement('div');
                            info.className = 'frame-info';
                            info.textContent = `${i + 1}/${frameCount}`;
                            frameItem.appendChild(info);

                            framesGrid.appendChild(frameItem);
                            // Â∫îÁî®ÈïúÂÉèÂà∞Êñ∞Ê∑ªÂä†ÁöÑÂ∏ßÈ¢ÑËßà
                            if (typeof refreshFramePreviewMirror === 'function') {
                                refreshFramePreviewMirror();
                            }
                            resolve();
                        };
                    });
                }

                updateStatus('ËßÜÈ¢ëÂ§ÑÁêÜÂÆåÊàêÔºåËØ∑ÈÄâÊã©ÂêàÈÄÇÁöÑÂ∏ß', 'ready');
                document.getElementById('process-video').disabled = false;
                // Â§ÑÁêÜÂÆåÊàêÂêéÁªü‰∏ÄÂà∑Êñ∞‰∏ÄÊ¨°
                if (typeof refreshFramePreviewMirror === 'function') {
                    refreshFramePreviewMirror();
                }

            } catch (error) {
                console.error('Â§ÑÁêÜËßÜÈ¢ëÊó∂Âá∫Èîô:', error);
                updateStatus('Â§ÑÁêÜÂ§±Ë¥•', 'error');
                document.getElementById('process-video').disabled = false;
            }
        }

        // Â§ÑÁêÜÂ∏ßÔºàÊòæÁ§∫Â∏ßÈ¢ÑËßàÔºâ
        function processFrames() {
            console.log('ÂºÄÂßãÂ§ÑÁêÜÂ∏ßÔºåÂ∏ßÊï∞Èáè:', frames.length);
            console.log('Â∏ßÊï∞ÊçÆÁ§∫‰æã:', frames[0]);
            
            if (frames.length === 0) {
                alert('Ê≤°ÊúâÂèØÂ§ÑÁêÜÁöÑÂ∏ßÔºåËØ∑ÂÖàÂΩïÂà∂ËßÜÈ¢ë');
                return;
            }

            updateStatus('Ê≠£Âú®ÁîüÊàêÂ∏ßÈ¢ÑËßà...', 'processing');
            document.getElementById('process-video').disabled = true;

            const framesContainer = document.getElementById('frames-container');
            framesContainer.innerHTML = '<div class="frames-grid" id="frames-grid"></div>';

            const framesGrid = document.getElementById('frames-grid');

            frames.forEach((frameData, index) => {
                const frameItem = document.createElement('div');
                frameItem.className = 'frame-item';
                frameItem.dataset.frameIndex = index;

                const img = document.createElement('img');
                img.src = frameData.imageData;
                img.onload = () => {
                    console.log(`Â∏ß ${index} Âä†ËΩΩÊàêÂäü`);
                    if (index === frames.length - 1) {
                        updateStatus('Â∏ßÈ¢ÑËßàÁîüÊàêÂÆåÊàêÔºåËØ∑ÈÄâÊã©ÂêàÈÄÇÁöÑÂ∏ß', 'ready');
                    }
                };
                img.onerror = () => {
                    console.error(`Â∏ß ${index} Âä†ËΩΩÂ§±Ë¥•`);
                };

                const info = document.createElement('div');
                info.className = 'frame-info';
                info.textContent = `${index + 1}/${frames.length}`;

                frameItem.appendChild(img);
                frameItem.appendChild(info);
                frameItem.onclick = () => selectFrame(index);

                framesGrid.appendChild(frameItem);
            });
        }

        // ÈÄâÊã©Â∏ß
        function selectFrame(frameIndex) {
            console.log('ÈÄâÊã©Â∏ß:', frameIndex);
            const frameItem = document.querySelector(`[data-frame-index="${frameIndex}"]`);
            console.log('ÊâæÂà∞ÁöÑÂ∏ßÂÖÉÁ¥†:', frameItem);

            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.frame-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            selectedFrames.clear();

            // ÈÄâÊã©ÂΩìÂâçÂ∏ß
            selectedFrames.add(frameIndex);
            frameItem.classList.add('selected');
            console.log('ÈÄâÊã©Â∏ß:', frameIndex);

            updateSelectedCount();

            // Ê∏ÖÁ©∫Â∑≤ÊúâÂùêÊ†áÔºå‰ª•‰æøÊ£ÄÊµãÁªìÊûúËÉΩÂÜôÂÖ•ÔºàdetectÂáΩÊï∞Âè™Â°´Á©∫Â≠óÊÆµÔºâ
            if (typeof clearAllKeypointInputs === 'function') {
                clearAllKeypointInputs();
            }

            // Ëá™Âä®Ê£ÄÊµãÂÖ≥ÈîÆÁÇπ
            detectKeypointsForSelectedFrames();
        }

        // Ê∏ÖÁ©∫ÈÄâÊã©
        function clearSelection() {
            selectedFrames.forEach(frameIndex => {
                const frameItem = document.querySelector(`[data-frame-index="${frameIndex}"]`);
                frameItem.classList.remove('selected');
            });
            selectedFrames.clear();
            updateSelectedCount();
        }

        // Êõ¥Êñ∞ÈÄâÊã©ËÆ°Êï∞
        function updateSelectedCount() {
            const count = selectedFrames.size;
            if (count === 0) {
                document.getElementById('selection-count').textContent = 'Êó†';
            } else {
                const frameIndex = Array.from(selectedFrames)[0];
                document.getElementById('selection-count').textContent = `Â∏ß ${frameIndex + 1}`;
            }
        }

        // Ê£ÄÊµãÂßøÂäø
        async function detectPose() {
            console.log('Ê£ÄÊµãÂßøÂäøÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
            console.log('ÈÄâ‰∏≠ÁöÑÂ∏ßÊï∞Èáè:', selectedFrames.size);
            if (selectedFrames.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊ£ÄÊµãÁöÑÂ∏ß');
                return;
            }

            updateStatus('Ê≠£Âú®Ê£ÄÊµãÂßøÂäø...', 'processing');
            document.getElementById('detect-pose').disabled = true;

            try {
                console.log('ÂºÄÂßãË∞ÉÁî®detectKeypointsForSelectedFrames');
                await detectKeypointsForSelectedFrames();
                console.log('detectKeypointsForSelectedFramesÂÆåÊàê');
                updateStatus('ÂßøÂäøÊ£ÄÊµãÂÆåÊàê', 'ready');
            } catch (error) {
                console.error('ÂßøÂäøÊ£ÄÊµãÂ§±Ë¥•:', error);
                updateStatus('ÂßøÂäøÊ£ÄÊµãÂ§±Ë¥•', 'error');
            } finally {
                document.getElementById('detect-pose').disabled = false;
            }
        }

        // ‰∏∫ÈÄâ‰∏≠ÁöÑÂ∏ßÊ£ÄÊµãÂÖ≥ÈîÆÁÇπ
        async function detectKeypointsForSelectedFrames() {
            const selectedFrameIndices = Array.from(selectedFrames);
            const frameData = selectedFrameIndices.map(index => frames[index]);

            console.log('ÂèëÈÄÅÁªôAPIÁöÑÂ∏ßÊï∞ÊçÆ:', frameData);

            try {
                const response = await fetch('/api/detect_keypoints_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ frames: frameData })
                });

                const result = await response.json();
                console.log('APIÂìçÂ∫î:', result);

                if (result.success && result.keypoints) {
                    keypointsData = result.keypoints;
                    console.log('ËÆæÁΩÆkeypointsData:', keypointsData);

                    // ‰ªÖÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂ∏ßÔºàÊàë‰ª¨Âº∫Âà∂ÂçïÈÄâÂ∏ßÔºâ
                    const frameIndex = Array.from(selectedFrames)[0];
                    const detected = keypointsData[frameIndex];
                    if (detected) {
                        // Â°´ÂÖÖÂùêÊ†áÔºàÂè™Â°´ÂÖÖÁ©∫ÁöÑÂ≠óÊÆµÔºâ
                        keypointNames.forEach(name => {
                            const vals = detected[name];
                            const xEl = document.getElementById(`kp-${name}-x`);
                            const yEl = document.getElementById(`kp-${name}-y`);
                            if (vals && xEl && yEl) {
                                const [x, y] = vals;
                                // Âè™Âú®Â≠óÊÆµ‰∏∫Á©∫Êó∂Â°´ÂÖÖÊé®ÁêÜÁªìÊûú
                                if (xEl.value.trim() === '') {
                                    xEl.value = Number.isFinite(x) ? x.toFixed(2) : '';
                                }
                                if (yEl.value.trim() === '') {
                                    yEl.value = Number.isFinite(y) ? y.toFixed(2) : '';
                                }
                            }
                        });

                        // Âú®ÁªìÊûúÂå∫ÂüüÁîªÂá∫Â∏¶ÂÖ≥ÈîÆÁÇπÁöÑÂõæÁâá
                        renderPosePreview(frameIndex, detected);
                    }
                } else {
                    console.error('APIËøîÂõûÂ§±Ë¥•:', result);
                    alert('ÂÖ≥ÈîÆÁÇπÊ£ÄÊµãÂ§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'));
                }

            } catch (error) {
                console.error('ÂÖ≥ÈîÆÁÇπÊ£ÄÊµãÂ§±Ë¥•:', error);
                alert('ÂÖ≥ÈîÆÁÇπÊ£ÄÊµãÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂàùÂßãÂåñÂÖ≥ÈîÆÁÇπÈÄâÊã©Âô®ÔºàË°®Ê†ºÔºöÂ§öÈÄâÂ§çÈÄâÊ°Ü+ÂêçÁß∞+X/YÔºâ
        function initializeKeypointsSelector() {
            const container = document.getElementById('keypoints-selector');
            container.innerHTML = '';

            const table = document.createElement('table');
            table.className = 'table table-dark table-striped';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th scope="col">ÈÄâÊã©</th>
                    <th scope="col">ÂÖ≥ÈîÆÁÇπÂêçÁß∞</th>
                    <th scope="col">X ÂùêÊ†á</th>
                    <th scope="col">Y ÂùêÊ†á</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            keypointNames.forEach(name => {
                const tr = document.createElement('tr');

                const tdSelect = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'core-keypoint';
                checkbox.id = `kp-${name}`;
                checkbox.value = name;
                checkbox.className = 'form-check-input';
                tdSelect.appendChild(checkbox);

                const tdName = document.createElement('td');
                tdName.textContent = name;

                const tdX = document.createElement('td');
                const inputX = document.createElement('input');
                inputX.type = 'text';
                inputX.id = `kp-${name}-x`;
                inputX.className = 'form-control';
                tdX.appendChild(inputX);

                const tdY = document.createElement('td');
                const inputY = document.createElement('input');
                inputY.type = 'text';
                inputY.id = `kp-${name}-y`;
                inputY.className = 'form-control';
                tdY.appendChild(inputY);

                tr.appendChild(tdSelect);
                tr.appendChild(tdName);
                tr.appendChild(tdX);
                tr.appendChild(tdY);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÂÖ≥ÈîÆÁÇπËæìÂÖ•Ê°ÜÔºà‰∏çÊîπÂèòÂ§çÈÄâÊ°ÜÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºâ
        function clearAllKeypointInputs() {
            keypointNames.forEach(name => {
                const xEl = document.getElementById(`kp-${name}-x`);
                const yEl = document.getElementById(`kp-${name}-y`);
                if (xEl) xEl.value = '';
                if (yEl) yEl.value = '';
            });
        }

        // ‰øùÂ≠òÂßøÂäø
        async function savePose() {
            const poseName = document.getElementById('pose-name').value.trim();
            const poseIndex = parseInt(document.getElementById('pose-index').value);
            const similarityThreshold = parseFloat(document.getElementById('similarity-threshold').value);
            const baseKeypoint = document.getElementById('base-keypoint').value;
            const keysInput = document.getElementById('keys-input').value.trim();
            const innerFlag = document.getElementById('inner-flag').checked;
            const poseImg = document.getElementById('pose-img').value.trim();

            if (!poseName || isNaN(poseIndex)) {
                alert('ËØ∑Â°´ÂÜôÂßøÂäøÂêçÁß∞ÂíåÁ¥¢Âºï');
                return;
            }

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊ†∏ÂøÉÂÖ≥ÈîÆÁÇπÔºàÂ§öÈÄâÔºâ
            const selectedKeypoints = Array.from(document.querySelectorAll('#keypoints-selector input[type="checkbox"][name="core-keypoint"]:checked'))
                .map(cb => cb.value);

            if (selectedKeypoints.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ê†∏ÂøÉÂÖ≥ÈîÆÁÇπ');
                return;
            }

            // ËÆ°ÁÆóÁõ∏ÂØπÂÖ≥ÈîÆÁÇπÊï∞ÊçÆÔºàcore - baseÔºâ
            let avgKeypoints;
            try {
                avgKeypoints = calculateAverageKeypoints(selectedKeypoints);
            } catch (e) {
                alert(e.message || 'ÂÖ≥ÈîÆÁÇπËÆ°ÁÆóÂ§±Ë¥•');
                return;
            }

            const poseData = {
                name: poseName,
                index: poseIndex,
                inner_flag: innerFlag,
                similarity_threshold: similarityThreshold,
                keys: keysInput ? keysInput.split(',').map(k => k.trim()) : [],
                basekeypoints: baseKeypoint,
                list_corekeypoints: selectedKeypoints,
                value_dict: avgKeypoints,
                pose_img: poseImg
            };

            try {
                const response = await fetch('/api/save_pose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(poseData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('ÂßøÂäø‰øùÂ≠òÊàêÂäüÔºÅ');
                    loadExistingPoses(); // ÈáçÊñ∞Âä†ËΩΩÂßøÂäøÂàóË°®
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('‰øùÂ≠òÂßøÂäøÂ§±Ë¥•:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•Âøó');
            }
        }

        // ËÆ°ÁÆóÁõ∏ÂØπÂÖ≥ÈîÆÁÇπÊï∞ÊçÆÔºövalue_dict = core_keypoint - basekeypoint
        // ÈúÄÊ±ÇÔºö
        // - Ëã•Âü∫ÂáÜÁÇπÊú™Â°´ÂÜôÔºåÂàôÊåâ 0 Â§ÑÁêÜ
        // - Ëã•Ê†∏ÂøÉÁÇπÊú™Â°´ÂÜôÔºåÂàôÁõ∏ÂØπÈáèÊåâ [0,0] ‰øùÂ≠òÔºåÁ°Æ‰øù‰∏ÄËá¥
        function calculateAverageKeypoints(selectedKeypoints) {
            const result = {};

            const base = document.getElementById('base-keypoint').value;
            const bxStr = document.getElementById(`kp-${base}-x`).value.trim();
            const byStr = document.getElementById(`kp-${base}-y`).value.trim();

            let bx = 0, by = 0;
            if (bxStr !== '' && byStr !== '') {
                const tbx = parseFloat(bxStr);
                const tby = parseFloat(byStr);
                if (Number.isFinite(tbx) && Number.isFinite(tby)) {
                    bx = tbx; by = tby;
                }
            }

            selectedKeypoints.forEach(kp => {
                const xStr = document.getElementById(`kp-${kp}-x`).value.trim();
                const yStr = document.getElementById(`kp-${kp}-y`).value.trim();
                if (xStr === '' || yStr === '') {
                    // Êú™Â°´ÂÜôÂàôÁõ∏ÂØπÈáèÊåâ 0 Â§ÑÁêÜ
                    result[kp] = [0, 0];
                    return;
                }
                const x = parseFloat(xStr);
                const y = parseFloat(yStr);
                if (!Number.isFinite(x) || !Number.isFinite(y)) {
                    // ÈùûÊ≥ïÂàôÊåâ 0 Â§ÑÁêÜ
                    result[kp] = [0, 0];
                    return;
                }
                // core - base
                result[kp] = [x - bx, y - by];
            });

            return result;
        }

        // Âä†ËΩΩÁé∞ÊúâÂßøÂäøÂà∞‰∏ãÊãâÊ°Ü
        async function loadExistingPoses() {
            try {
                const response = await fetch('/static/configs.json');
                const poses = await response.json();
                const select = document.getElementById('existing-poses');
                select.innerHTML = '<option value="">Êñ∞Âª∫ÂßøÂäø</option>';
                poses.forEach(pose => {
                    const option = document.createElement('option');
                    option.value = pose.index; // ‰ΩøÁî®index‰Ωú‰∏∫ÂîØ‰∏ÄÊ†áËØÜÁ¨¶
                    option.textContent = pose.name;
                    option.dataset.poseImg = pose.pose_img || ''; // Â≠òÂÇ®ÂßøÂäøÂõæÁâá‰ø°ÊÅØ
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Âä†ËΩΩÂßøÂäøÂàóË°®Â§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÈÄâ‰∏≠ÁöÑÂßøÂäø
        async function loadSelectedPose() {
            const select = document.getElementById('existing-poses');
            const poseIndex = parseInt(select.value);
            if (!poseIndex && poseIndex !== 0) {
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('pose-name').value = '';
                document.getElementById('pose-index').value = '';
                document.getElementById('similarity-threshold').value = '0.95';
                document.getElementById('base-keypoint').value = 'nose';
                document.getElementById('keys-input').value = '';
                document.getElementById('inner-flag').checked = false;
                document.getElementById('pose-img').value = '';
                
                // Ê∏ÖÁ©∫Ê†∏ÂøÉÂÖ≥ÈîÆÁÇπÈÄâÊã©ÂíåÂùêÊ†á
                document.querySelectorAll('#keypoints-selector input[type="checkbox"][name="core-keypoint"]').forEach(cb => {
                    cb.checked = false;
                });
                keypointNames.forEach(name => {
                    const xEl = document.getElementById(`kp-${name}-x`);
                    const yEl = document.getElementById(`kp-${name}-y`);
                    if (xEl) xEl.value = '';
                    if (yEl) yEl.value = '';
                });
                
                document.getElementById('delete-pose').disabled = true;
                return;
            }

            try {
                const response = await fetch('/static/configs.json');
                const poses = await response.json();
                const pose = poses.find(p => p.index === poseIndex);

                if (pose) {
                    // ÂÖàÊ∏ÖÁ©∫ÊâÄÊúâÂÖ≥ÈîÆÁÇπËæìÂÖ•ÔºåÈÅøÂÖçÊÆãÁïôÂÄºÈòªÊ≠¢ÂêéÁª≠Âà∑Êñ∞
                    if (typeof clearAllKeypointInputs === 'function') {
                        clearAllKeypointInputs();
                    }

                    document.getElementById('pose-name').value = pose.name || '';
                    document.getElementById('pose-index').value = pose.index || '';
                    document.getElementById('similarity-threshold').value = pose.similarity_threshold || '0.95';
                    document.getElementById('base-keypoint').value = pose.basekeypoints || 'nose';
                    document.getElementById('keys-input').value = pose.keys ? pose.keys.join(',') : '';
                    document.getElementById('inner-flag').checked = pose.inner_flag || false;
                    document.getElementById('pose-img').value = pose.pose_img || '';

                    // ÊÅ¢Â§çÊ†∏ÂøÉÂÖ≥ÈîÆÁÇπÔºàÂ§öÈÄâÔºâ
                    const coreList = pose.list_corekeypoints || [];
                    document.querySelectorAll('#keypoints-selector input[type="checkbox"][name="core-keypoint"]').forEach(cb => {
                        cb.checked = coreList.includes(cb.value);
                    });

                    // Â∞ÜÁõ∏ÂØπÂùêÊ†áËΩ¨Êç¢‰∏∫ÁªùÂØπÂùêÊ†áÊòæÁ§∫Ôºöabs = rel + base
                    if (pose.value_dict) {
                        const baseName = pose.basekeypoints || 'nose';
                        const bxEl = document.getElementById(`kp-${baseName}-x`);
                        const byEl = document.getElementById(`kp-${baseName}-y`);
                        let bx = 0, by = 0;
                        if (bxEl && bxEl.value !== '' && byEl && byEl.value !== '') {
                            const tbx = parseFloat(bxEl.value);
                            const tby = parseFloat(byEl.value);
                            if (Number.isFinite(tbx) && Number.isFinite(tby)) { bx = tbx; by = tby; }
                        }

                        // ÈÅçÂéÜÂΩìÂâçÂ∑≤Áü•ÁöÑÊ†∏ÂøÉÁÇπÈõÜÂêàÔºàÊù•Ëá™ pose.list_corekeypointsÔºâ
                        const coreList = pose.list_corekeypoints || Object.keys(pose.value_dict);
                        coreList.forEach(keypointName => {
                            const rel = pose.value_dict[keypointName] || [0, 0];
                            const xEl = document.getElementById(`kp-${keypointName}-x`);
                            const yEl = document.getElementById(`kp-${keypointName}-y`);
                            if (xEl && yEl && Array.isArray(rel) && rel.length >= 2) {
                                const rx = Number.isFinite(rel[0]) ? rel[0] : 0;
                                const ry = Number.isFinite(rel[1]) ? rel[1] : 0;
                                xEl.value = (bx + rx).toFixed(2);
                                yEl.value = (by + ry).toFixed(2);
                            }
                        });
                    }

                    updateStatus('ÂßøÂäøÂä†ËΩΩÊàêÂäü', 'ready');
                    document.getElementById('delete-pose').disabled = false;
                } else {
                    updateStatus('Êú™ÊâæÂà∞ÊåáÂÆöÁöÑÂßøÂäø', 'error');
                    document.getElementById('delete-pose').disabled = true;
                    // Ê∏ÖÁ©∫ÂùêÊ†áÂ≠óÊÆµ
                    keypointNames.forEach(name => {
                        const xEl = document.getElementById(`kp-${name}-x`);
                        const yEl = document.getElementById(`kp-${name}-y`);
                        if (xEl) xEl.value = '';
                        if (yEl) yEl.value = '';
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂßøÂäøÂ§±Ë¥•:', error);
                updateStatus('Âä†ËΩΩÂ§±Ë¥•', 'error');
                document.getElementById('delete-pose').disabled = true;
                // Ê∏ÖÁ©∫ÂùêÊ†áÂ≠óÊÆµ
                keypointNames.forEach(name => {
                    const xEl = document.getElementById(`kp-${name}-x`);
                    const yEl = document.getElementById(`kp-${name}-y`);
                    if (xEl) xEl.value = '';
                    if (yEl) yEl.value = '';
                });
            }
        }

        // Âà†Èô§ÂßøÂäø
        async function deletePose() {
            const select = document.getElementById('existing-poses');
            const poseIndex = parseInt(select.value);
            if (!Number.isInteger(poseIndex)) {
                alert('ËØ∑ÂÖà‰ªéÂàóË°®‰∏≠ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂßøÂäø');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Á¥¢Âºï‰∏∫ ${poseIndex} ÁöÑÂßøÂäøÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete_pose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: poseIndex })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Âà†Èô§ÊàêÂäü');
                    await loadExistingPoses();
                    // ÈáçÁΩÆÈÄâÊã©‰∏∫‚ÄúÊñ∞Âª∫ÂßøÂäø‚Äù
                    document.getElementById('existing-poses').value = '';
                    await loadSelectedPose();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (err) {
                console.error('Âà†Èô§ÂßøÂäøÂ§±Ë¥•:', err);
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•Âøó');
            }
        }

        // ËØªÂèñÂíå‰øùÂ≠òÈïúÂÉèÂÅèÂ•Ω
        function getMirrorPreference() {
            const v = localStorage.getItem('pose_mirror_enabled');
            return v === null ? true : v === 'true'; // ÈªòËÆ§ÂºÄÂêØ
        }

        function setMirrorPreference(enabled) {
            localStorage.setItem('pose_mirror_enabled', enabled ? 'true' : 'false');
        }

        // Â∫îÁî®ÈïúÂÉèÂà∞ËßÜÈ¢ëÂÖÉÁ¥†
        function applyMirrorToVideos(enabled) {
            const preview = document.getElementById('video-preview');
            const recorded = document.getElementById('recorded-video');
            const t = enabled ? 'scaleX(-1)' : 'none';
            if (preview) preview.style.transform = t;
            if (recorded) recorded.style.transform = t;
        }

        // Â∫îÁî®ÈïúÂÉèÂà∞Â∏ßÈ¢ÑËßàÂÆπÂô®
        function applyMirrorToFrames(enabled) {
            // Ê≥®ÊÑèÔºöÂ∏ßÂõæÂÉèÊï∞ÊçÆÂú®ÊäìÂèñÈò∂ÊÆµÂ∑≤Ê†πÊçÆÂÅèÂ•ΩËøõË°åÈïúÂÉèÁªòÂà∂
            // ËøôÈáå‰∏çÂÜçÂØπÈ¢ÑËßàimgÂÅöCSSÈïúÂÉèÔºåÈÅøÂÖçÂèåÈáçÈïúÂÉèÂØºËá¥ÊñπÂêëÈîôËØØ
        }

        // ÂàùÂßãÂåñÂºÄÂÖ≥ÂíåÁõëÂê¨
        document.addEventListener('DOMContentLoaded', () => {
            const mirrorToggle = document.getElementById('mirror-toggle');
            const enabled = getMirrorPreference();
            if (mirrorToggle) {
                mirrorToggle.checked = enabled;
                mirrorToggle.addEventListener('change', () => {
                    const en = mirrorToggle.checked;
                    setMirrorPreference(en);
                    applyMirrorToVideos(en);
                    applyMirrorToFrames(en);
                    // Ëã•Â∑≤ÊúâÂΩïÂà∂ËßÜÈ¢ëÔºåÂàáÊç¢ÈïúÂÉèÂêéËá™Âä®ÈáçÊñ∞Â§ÑÁêÜÂ∏ß‰ª•Â∫îÁî®Êñ∞ÊñπÂêë
                    const recorded = document.getElementById('recorded-video');
                    if (recorded && recorded.src) {
                        // Ê∏ÖÁ©∫Â∑≤ÊúâÂ∏ß
                        const framesContainer = document.getElementById('frames-container');
                        if (framesContainer) framesContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">Ê≠£Âú®Ê†πÊçÆÊñ∞ÊñπÂêëÈáçÊñ∞ÁîüÊàêÂ∏ß...</p>';
                        // ÈáçÊñ∞Â§ÑÁêÜ
                        setTimeout(() => { processVideo(); }, 50);
                    }
                });
            }
            applyMirrorToVideos(enabled);
        });

        // Âú®Â§ÑÁêÜÂÆåÂ∏ßÂπ∂ÂàõÂª∫È¢ÑËßàÂêéË∞ÉÁî®‰∏ÄÊ¨°
        function refreshFramePreviewMirror() {
            const enabled = getMirrorPreference();
            applyMirrorToFrames(enabled);
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        function updateStatus(text, status) {
            document.getElementById('status-text').textContent = text;
            const indicator = document.getElementById('status-indicator');

            indicator.className = 'status-indicator';
            if (status === 'recording') {
                indicator.classList.add('status-recording');
            } else if (status === 'processing') {
                indicator.classList.add('status-processing');
            } else if (status === 'ready') {
                indicator.classList.add('status-ready');
            }
        }

        // Âú®ÁªìÊûúÂå∫ÂüüÊ∏≤ÊüìÂÖ≥ÈîÆÁÇπÔºà‰ΩøÁî®APIÁªòÂà∂Ôºâ
        async function renderPosePreview(frameIndex, keypoints) {
            const resultDiv = document.getElementById('pose-results');
            resultDiv.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'pose-result-item';

            // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÂßøÂäøÂõæÁâá
            const select = document.getElementById('existing-poses');
            const poseIndex = parseInt(select.value);
            let poseImgSrc = null;

            if (!isNaN(poseIndex)) {
                // ‰ªéÂ∑≤Âä†ËΩΩÁöÑÂßøÂäøÂàóË°®‰∏≠Êü•Êâæ
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption && selectedOption.dataset && selectedOption.dataset.poseImg) {
                    poseImgSrc = selectedOption.dataset.poseImg;
                }
            }

            // Ëß£ÊûêÂßøÂäøÂõæÁâáË∑ØÂæÑÔºåÂÖºÂÆπ‰ª•‰∏ãËæìÂÖ•Ôºö
            // - "MyPose.jpg"
            // - "Images/MyPose.jpg"
            // - "Source/Images/MyPose.jpg"
            // - "/static/Images/MyPose.jpg"
            function resolvePoseImageUrl(src) {
                if (!src) return null;
                let s = String(src).trim();
                if (s.startsWith('/static/')) return s; // Â∑≤ÊòØÈùôÊÄÅË∑ØÂæÑ
                if (s.startsWith('Source/Images/')) {
                    s = s.substring('Source/Images/'.length).trim();
                } else if (s.startsWith('Images/')) {
                    s = s.substring('Images/'.length).trim();
                } else if (s.includes('/')) {
                    // ÂÖúÂ∫ïÔºöÂè™ÂèñÊñá‰ª∂ÂêçÈÉ®ÂàÜ
                    const parts = s.split('/');
                    s = parts[parts.length - 1].trim();
                }
                return `/static/Images/${s}`;
            }

            // Â¶ÇÊûúÊúâÂßøÂäøÂõæÁâáÔºåÂÖàÊòæÁ§∫ÂõæÁâá
            if (poseImgSrc) {
                const poseImg = document.createElement('img');
                poseImg.src = resolvePoseImageUrl(poseImgSrc);
                poseImg.className = 'pose-reference-img';
                poseImg.style.maxWidth = '200px';
                poseImg.style.maxHeight = '150px';
                poseImg.style.marginBottom = '10px';
                poseImg.style.border = '2px solid #4CAF50';
                poseImg.style.borderRadius = '5px';
                poseImg.onerror = () => {
                    console.warn(`Êó†Ê≥ïÂä†ËΩΩÂßøÂäøÂõæÁâá: ${poseImgSrc}`);
                    poseImg.style.display = 'none';
                };
                wrapper.appendChild(poseImg);
            }

            try {
                // Ë∞ÉÁî®APIËé∑ÂèñÁªòÂà∂‰∫ÜÂÖ≥ÈîÆÁÇπÁöÑÂõæÂÉè
                const response = await fetch('/api/render_keypoints', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ frame: frames[frameIndex] })
                });

                const result = await response.json();
                
                if (result.success && result.imageData) {
                    const keypointsImg = document.createElement('img');
                    keypointsImg.src = result.imageData;
                    keypointsImg.className = 'pose-canvas';
                    keypointsImg.style.maxWidth = '100%';
                    keypointsImg.style.height = 'auto';
                    wrapper.appendChild(keypointsImg);
                } else {
                    // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = 'ÂÖ≥ÈîÆÁÇπÊ∏≤ÊüìÂ§±Ë¥•';
                    errorDiv.style.color = 'red';
                    errorDiv.style.padding = '20px';
                    errorDiv.style.textAlign = 'center';
                    wrapper.appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Ê∏≤ÊüìÂÖ≥ÈîÆÁÇπÊó∂Âá∫Èîô:', error);
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'ÂÖ≥ÈîÆÁÇπÊ∏≤ÊüìÂá∫Èîô';
                errorDiv.style.color = 'red';
                errorDiv.style.padding = '20px';
                errorDiv.style.textAlign = 'center';
                wrapper.appendChild(errorDiv);
            }

            resultDiv.appendChild(wrapper);
        }
    </script>
</body>
</html>